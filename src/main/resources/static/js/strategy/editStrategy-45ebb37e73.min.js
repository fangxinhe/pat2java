$(".journal-list li").on("click", function () {
    $(this).addClass("add-border-li").siblings().removeClass("add-border-li");
    var e = $(this).index();
    $(".journal-detal .change-box").hide().eq(e).show()
}), $(".jour-down").on("click", function () {
    $(this).toggleClass("jour-up");
    var e = $(this).hasClass("jour-up");
    e ? ($(this).parent(".journal").addClass("journal-marg"), $(".bianji-con").hide()) : ($(this).parent(".journal").removeClass("journal-marg"), $(".bianji-con").show())
});
var sourceCodeBody = $("#sourceCode1").val(), autoComplateData = null;
$().ready(function () {
    function e(e) {
        for (var a = e.length, t = [], s = 0, o = [], n = 0; a >= 0; a--)")" == e.charAt(a) && (n++, o.push(a)), "(" == e.charAt(a) && (n--, 0 == n ? t.push(a) : s = a);
        return 0 == n ? 0 != o.length ? e.substring(0, t[0]) + e.substring(o[0] + 1) : e.substring(0, t[0]) : e.substring(s + 1)
    }

    function a(e, a, t, s) {
        var o = [], n = e.typePropMap[a];
        if (n) {
            $.each(e.typePropMap[a], function (e, a) {
                $.each(a, function (e, a) {
                    if ("func" == a.type) {
                        var t = a.showPara ? "(" + a.showPara.join(", ") + ")" : "";
                        o.push({value: a.name + "()", caption: a.name + t, meta: a.showRetType || a.retType})
                    } else o.push({value: a.name, caption: a.name, meta: a.showRetType || a.retType})
                })
            });
            var r = {
                getCompletions: function (e, a, t, s, n) {
                    var r = $.grep(o, function (e) {
                        return e.value.indexOf(s) >= 0
                    });
                    n(null, r.map(function (e) {
                        return {value: e.value, meta: e.meta, caption: e.caption}
                    }))
                }
            };
            t.completers = [r], t.execCommand("startAutocomplete"), t.completers = s
        }
    }

    var t = ace.edit("sourceCode");
    t.setTheme("ace/theme/xcode"), "java" == $("#languageType").val() ? t.getSession().setMode("ace/mode/java") : t.getSession().setMode("ace/mode/python"), t.setValue(sourceCodeBody), t.setFontSize(14), t.setShowPrintMargin(!1), 1 == $("#simulationStatus").val() ? (strategy.editVue.canEdit = !1, t.setReadOnly(!0), t.getSession().setUseWrapMode(!0), $("#sourceCode").on("input", function () {
        alert("该策略无法编辿!")
    }), $("#strategyName").attr("readonly", !0), $("#editMessage").html("模拟中的策略无法编辑").show()) : ($("#sourceCode").on("input", function () {
        $("#strategySaveBtn").html("保存").removeClass("add-preservation"), $("#strategySaveBtn").attr("data-disabled", !1)
    }), $("#strategyName").change(function () {
        $("#strategySaveBtn").html("保存").removeClass("add-preservation"), $("#strategySaveBtn").attr("data-disabled", !1)
    })), $(".status-bar").draggable(), t.commands.addCommand({
        name: "startStockSearch",
        bindKey: {win: "Ctrl-I", mac: "Command-I"},
        exec: function (e) {
            strategy.stockNotify = !strategy.stockNotify, strategy.stockNotify ? strategy.startStockSearch(e) : strategy.closeStockSearch(e)
        }
    }), t.commands.on("afterExec", function (t, s) {
        if ("insertstring" == t.command.name && "." == t.args) {
            var o = t.editor.completers, n = t.editor.selection.getCursor(), r = t.editor.session.getLine(n.row).substring(0, n.column), i = /\w+/, l = /\w+/g, c = /\([^\)]*\)/g;
            for (r = e(r); r != e(r);)r = e(r);
            if (r = r.replace(c, ""), i.test(r.charAt(r.length - 2))) {
                var d = r.match(l);
                if (d) {
                    var u = d[d.length - 1];
                    autoComplateData.nameTypeMap[u] && a(autoComplateData, autoComplateData.nameTypeMap[u], t.editor, o);
                    var m = [];
                    $.each(autoComplateData.typePropMap, function (e, s) {
                        var n = d[d.length - 2];
                        $.each(autoComplateData.typePropMap, function (e, a) {
                            a[n] && $.each(a[n], function (e, a) {
                                m.push(a.retType)
                            })
                        }), s[u] && $.each(s[u], function (s, n) {
                            (0 == m.length || m.join(",").indexOf(e) >= 0) && a(autoComplateData, n.retType, t.editor, o)
                        })
                    })
                }
            }
        }
    }), t.gotoLine(1), strategy.enableCodeHinting(t), $("#logarea").scroll(function () {
        var e = $("#logarea").height(), a = $("#logarea")[0].scrollHeight, t = $("#logarea").scrollTop(), s = (a - e - t) / e;
        s < .05 && strategy.editVue.readLogs(100)
    })
});
//, window.localStorage.getItem("hasSeeEditGuide") || ($(".bianyi").addClass("ad-bian"), $(".windowmask").show(), $(".state-wrap4").show(), $(".state4").one("click", function () {
//    $(".state-wrap4").hide(), $(".state-wrap5").show(), $(".bianyi").removeClass("ad-bian"), $(".edi-wraps").addClass("add-edi-wraps")
//}), $(".state4-close").one("click", function () {
//    $(".state-wrap4").hide(), $(".windowmask").hide(), $(".state-wrap6").remove(), $(".state-wrap5").remove(), window.localStorage.setItem("hasSeeEditGuide", !0)
//}), $(".bianyi").one("click", function () {
//    $(".state-wrap4").hide(), $(".state-wrap5").show(), $(this).removeClass("ad-bian"), $(".edi-wraps").addClass("add-edi-wraps")
//}), $(".state5").one("click", function () {
//    $(".state-wrap5").remove(), $(".state-wrap6").show(), $(".edi-wraps").removeClass("add-edi-wraps"), $(".journal").addClass("add-journal")
//}), $(".renturn-back").one("click", function () {
//    $(".state-wrap5").remove(), $(".state-wrap6").show(), $(".edi-wraps").removeClass("add-edi-wraps"), $(".journal").addClass("add-journal")
//}), $(".state6").one("click", function () {
//    $(".state-wrap6").remove(), $(".windowmask").hide(), $(".journal").removeClass("add-journal"), window.localStorage.setItem("hasSeeEditGuide", !0)
//}), $(".state6-close").one("click", function () {
//    $(".state-wrap6").hide(), $(".windowmask").hide(), $(".journal").removeClass("add-journal"), window.localStorage.setItem("hasSeeEditGuide", !0)
//}), $(".state5-close").one("click", function () {
//    $(".state-wrap6").remove(), $(".state-wrap5").hide(), $(".windowmask").hide(), $(".edi-wraps").removeClass("add-edi-wraps"), window.localStorage.setItem("hasSeeEditGuide", !0)
//}));
var strategy = new function () {
    "use strict";
    function e() {
        var e = $("#endDate").val(), a = [["week", [1]], ["month", [1, 2, 3, 4, 6]]];
        HighChartsUtil.initCharts({
            container: "backTestChart",
            title: "量化交易收益囿",
            xAxis: {
                minorTickInterval: 5,
                minTickInterval: 80,
                max: new Date(e).getTime(),
                gridLineWidth: 1,
                startOnTick: !0,
                ordinal: !1,
                dateTimeLabelFormats: {
                    second: "%Y-%m-%d<br/>%H:%M:%S",
                    minute: "%Y-%m-%d<br/>%H:%M",
                    hour: "%Y-%m-%d<br/>%H:%M",
                    day: "%Y<br/>%m-%d",
                    week: "%Y<br/>%m-%d",
                    month: "%Y-%m",
                    year: "%Y"
                }
            },
            yAxis: [{
                minorTickInterval: "auto",
                minorTickLength: 10,
                labels: {align: "right", format: "{value}%", x: -3},
                opposite: !0,
                height: "100%",
                lineWidth: 0,
                plotLines: [{value: 0, width: 1, color: "#808080"}]
            }],
            seriesArray: [{
                type: "spline",
                name: w.name,
                data: w.data,
                dataGrouping: {units: a},
                tooltip: {valueSuffix: "%"}
            }, {type: "areaspline", name: C.name, data: C.data, dataGrouping: {units: a}, tooltip: {valueSuffix: "%"}}]
        })
    }

    function a(e) {
        if (e) {
            $("#hcsy").html((100 * e.quantSummary.cumulativePercent).toFixed(2) + "%"), $("#hcnhsy").html((100 * e.quantSummary.yearPercent).toFixed(2) + "%"), $("#jzsy").html((100 * e.quantSummary.benchmarkPercent).toFixed(2) + "%"), $("#compileValue").html(e.runPercent + "%");
            var a = $(".b-du").width();
            $("#compileBar").width(e.runPercent * a / 100)
        }
    }

    function t(e) {
        try {
            var a = JSON.parse(e);
            a && a.success ? (s(a), a.end && ($(".b-jin").hide(), $("#compileValue").html("0%"), $("#compileBar").width(0), h.backTestStatus = "回测完成")) : ($(".b-jin").hide(), $("#compileValue").html("0%"), $("#compileBar").width(0), $("#errorarea").addClass("chang-show"), $("#errorTab").addClass("add-border-li"), $("#logTab").removeClass("add-border-li"),  $("#logarea").hide(), $("#errorarea").show(), $("#errorarea").html("<pre>" + a.message.replace(new RegExp(/(<)/g), "&lt;").replace(new RegExp(/(>)/g), "&gt;") + "</pre><br/>"))
        } catch (e) {
        }
    }

    function s(t) {
        if (t.dayProfitVo && (f = t.dayProfitVo), t.logOutputs && (l = l.concat(t.logOutputs)), !t.data)return !1;
        if (S) {
            var s = $("#backTestChart").highcharts();
            w.data = w.data.concat(t.data.incomeList[0].data), C.data = C.data.concat(t.data.incomeList[1].data), s.series[0].setData(w.data), s.series[1].setData(C.data)
        } else {
            if ($("#logarea").html(""), c < 50 && !d) {
                h.readLogs(100), d = !0;
                var o = setInterval(function () {
                    h.readLogs(100), console.log("已显示日志条数：" + c), c >= 50 && (console.log("####Stop auto loading logs!####"), clearInterval(o))
                }, 3e3)
            }
            w = t.data.incomeList[0], C = t.data.incomeList[1], w && w.data && 0 != w.data.length && (S = !0, e())
        }
        a(f)
    }

    function o(e) {
        var a = m.getValue(), t = Base64.encode(a);
        return "" == a || void 0 == a || null == a || "" == $.trim(a) ? ($("#message").text("策略代码不能为空＿"), i.showLayer($("#responseBox")), !1) : "" == $.trim($("#strategyName").val()) ? ($("#message").text("策略名称不可为空＿"), i.showLayer($("#responseBox")), !1) : void $.post("/strategy/saveStrategy", {
            userPin: $("#userPin").val(),
            strategyId: $("#strategyId").val(),
            strategyName: $("#strategyName").val(),
            sourceCode: e ? t : null,
            startDate: $("#startDate").val() + " 00:00:00",
            endDate: $("#endDate").val() + " 23:59:59",
            regressionType: $("#regressionType").attr("data-value"),
            principal: $("#principal").val(),
            languageType: $("#languageType").val()
        }).done(function (e) {
            if (e.success) {
                if (g)return window.location.href = "/run/" + $("#strategyId").val(), !1;
                if (v)return n(), v = !1, !1;
                $("#strategySaveBtn").html("已保孿").addClass("add-preservation"), $("#strategySaveBtn").attr("data-disabled", !0), setTimeout("$('#strategySaveBtn').html('保存').removeClass('add-preservation'); $('#strategySaveBtn').attr('data-disabled', false);", 3e3)
            } else $("#message").text(e.message), i.showLayer($("#responseBox"))
        })
    }

    function n() {
        var e = m.getValue();
        if ("" == e || void 0 == e || null == e || "" == jQuery.trim(e))return $("#message").text("策略代码不能为空＿"), i.showLayer($("#responseBox")), !1;
        if (new Date($("#startDate").val()).getTime() > new Date($("#endDate").val()).getTime())return $("#message").text("时间区域选择不正确！"), i.showLayer($("#responseBox")), !1;
        r(), $(".b-jin").show();
        var a = (new Date).getTime();
        $("#requestTime").val(a), $("#logarea").html("<span class='b-jin-text'>请稍后，正在进行编译...</span>"), null == y || y.readyState == SockJS.CLOSED ? (y = new SockJS("//" + window.location.host + "/getResult", null, {protocols_whitelist: ["websocket"]}), y.onopen = function () {
            console.log("Socket is Open!"), y.send(JSON.stringify({
                userPin: $("#userPin").val(),
                strategyId: $("#strategyId").val(),
                requestTime: $("#requestTime").val(),
                isReconnect: !1
            }))
        }, y.onmessage = function (e) {
            t(e.data)
        }, y.onclose = function () {
            console.log("Socket Close!")
        }) : y.send(JSON.stringify({userPin: $("#userPin").val(), strategyId: $("#strategyId").val(), requestTime: a}))
    }

    function r() {
        $("#hcsy").html("--"), $("#hcnhsy").html("--"), $("#jzsy").html("--"), $("#backTestChart").html(""), $("#logarea").html(""), $("#errorarea").html(""), S = !1, c = 0, d = !1, l = []
    }

    var i = null;
    seajs.use("financial/common/module/popup/1.0.0/js/popup", function (e) {
        i = e
    });
    var l = [], c = 0, d = !1, u = ace.require("ace/ext/language_tools"), m = ace.edit("sourceCode"), p = {
        format: "YYYY-MM-DD",
        minDate: new Date(2e3, 0, 1),
        maxDate: new Date,
        yearRange: [2e3, 2017],
        i18n: {
            previousMonth: "上个朿",
            nextMonth: "下个朿",
            months: ["一朿", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一朿", "十二朿"],
            weekdays: ["星期旿", "星期一", "星期亿", "星期丿", "星期囿", "星期亿", "星期兿"],
            weekdaysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"]
        }
    }, h = ($("#startDate").pikaday(p), $("#endDate").pikaday(p), new Vue({
        el: "#vueArea",
        data: {canEdit: !0, contestId: null, onContest: !1, versionId: null, backTestStatus: "回测丿", dayProfits: []},
        methods: {
            readLogs: function (e) {
                if (console.log("Read Log starting..."), l.length > e)for (var a = 0; a < e; a++) {
                    c++;
                    var t = l.shift(), s = " <span style='color: #393'>" + t.level + "</span> ";
                    "ERROR" == t.level && (s = " <span style='color: #ff5d5b'>" + t.level + "</span> ");
                    var o = "SYSTEM";
                    t.date && (o = new Date(t.date).format("yyyy-MM-dd hh:mm:ss")), $("#logarea").append("<span style='color: #5584ff'>" + o + "</span>" + s + "<pre style='display: inline-block; margin: 0'>" + t.content.replace("<", "&lt;").replace(">", "&gt;") + "</pre><br/>")
                } else for (var a = 0; a < l.length; a++) {
                    c++;
                    var t = l.shift(), s = " <span style='color: #393'>" + t.level + "</span> ";
                    "ERROR" == t.level && (s = " <span style='color: #ff5d5b'>" + t.level + "</span> ");
                    var o = "SYSTEM";
                    t.date && (o = new Date(t.date).format("yyyy-MM-dd hh:mm:ss")), $("#logarea").append("<span style='color: #5584ff'>" + o + "</span>" + s + "<pre style='display: inline-block; margin: 0'>" + t.content.replace("<", "&lt;").replace(">", "&gt;") + "</pre><br/>")
                }
            }
        }
    })), g = !1;
    this.editVue = h;
    var v = !1, y = null;
    this.changeKeyboard = function (e) {
        e && "string" == typeof e && ("vim" == e ? (m.setKeyboardHandler("ace/keyboard/vim"), $("#vimKey").addClass("col-red"), $("#emacsKey").removeClass("col-red"), $("#defaultKey").removeClass("col-red")) : "emacs" == e ? (m.setKeyboardHandler("ace/keyboard/emacs"), $("#emacsKey").addClass("col-red"), $("#vimKey").removeClass("col-red"), $("#defaultKey").removeClass("col-red")) : "default" == e && (m.setKeyboardHandler(), $("#defaultKey").addClass("col-red"), $("#emacsKey").removeClass("col-red"), $("#vimKey").removeClass("col-red")))
    }, this.changeTheme = function (e) {
        e && "string" == typeof e && ("xcode" == e ? (m.setTheme("ace/theme/xcode"), $("#xcodeTheme").addClass("col-red"), $("#monokaiTheme").removeClass("col-red")) : "monokai" == e && (m.setTheme("ace/theme/monokai"), $("#monokaiTheme").addClass("col-red"), $("#xcodeTheme").removeClass("col-red")))
    }, this.changeFontSize = function (e) {
        e && "number" == typeof e && (12 == e ? (m.setFontSize(e), $("#minFontSize").addClass("col-red"), $("#midFontSize").removeClass("col-red"), $("#maxFontSize").removeClass("col-red")) : 14 == e ? (m.setFontSize(e), $("#midFontSize").addClass("col-red"), $("#minFontSize").removeClass("col-red"), $("#maxFontSize").removeClass("col-red")) : 16 == e && (m.setFontSize(e), $("#maxFontSize").addClass("col-red"), $("#minFontSize").removeClass("col-red"), $("#midFontSize").removeClass("col-red")))
    }, this.openSearch = function () {
        m.execCommand("find")
    }, this.selectRegressionType = function (e) {
        $("#regressionType").attr("data-value", $(e).attr("data-value"))
    }, this.startStockSearch = function (e) {
        console.log("开启股票搜紿..."), $(".status-bar").addClass("status-bar-active"), $(".status-bar").html($(".status-bar").attr("data-close")), e.commands.addCommand({
            name: "exitStockSearch",
            bindKey: {win: "Esc|Return", mac: "Esc|Return", sender: "editor|cli"},
            exec: function (e) {
                strategy.stockNotify = !1, strategy.closeStockSearch(e)
            }
        });
        var a = {
            getCompletions: function (e, a, t, s, o) {
                return 0 === s.length ? void o(null, []) : void o(null, stocks.map(function (e) {
                    return {name: e.value, value: e.value, caption: e.caption, meta: e.meta}
                }))
            }
        };
        u.setCompleters([a]), e.setOptions({enableBasicAutocompletion: !0})
    }, this.closeStockSearch = function (e) {
        console.log("关闭股票搜索"), $(".status-bar").removeClass("status-bar-active"), $(".status-bar").html($(".status-bar").attr("data-enter")), e.commands.removeCommand("exitStockSearch"), strategy.enableCodeHinting(e)
    }, this.enableCodeHinting = function (e) {
        var a = [], t = [], s = $("#languageType").val();
        $.getJSON("/resources/jslib/ace/snippets/" + s + "-api.json", function (o) {
            autoComplateData = o;
            var n = o.nameTypeMap, r = o.typePropMap, i = o.staticMethodMap;
            $.each(n, function (e, s) {
                a.push({
                    value: e || s,
                    caption: e,
                    meta: s ? e.charAt(0).match(/[A-Z]/) ? "SDK Class" : "Local" : "Keyword"
                }), r[s] && $.each(r[s], function (a, s) {
                    $.each(s, function (a, s) {
                        if ("func" == s.type) {
                            var o = s.showPara ? "(" + s.showPara.join(", ") + ")" : "";
                            t.push({
                                value: e + "." + s.name + "()",
                                caption: e + "." + s.name + o,
                                meta: s.showRetType || s.retType
                            })
                        } else t.push({
                            value: e + "." + s.name,
                            caption: e + "." + s.name,
                            meta: s.showRetType || s.retType
                        })
                    })
                })
            }), "python" == s && ($.each(r, function (e, a) {
                $.each(a, function (a, s) {
                    $.each(s, function (a, s) {
                        if ("func" == s.type) {
                            var o = s.showPara ? "(" + s.showPara.join(", ") + ")" : "";
                            t.push({
                                value: e + "." + s.name + "()",
                                caption: e + "." + s.name + o,
                                meta: s.showRetType || s.retType
                            })
                        } else t.push({
                            value: e + "." + s.name,
                            caption: e + "." + s.name,
                            meta: s.showRetType || s.retType
                        })
                    })
                })
            }), $.each(i, function (e, a) {
                t.push({value: e + "()", caption: e + "(" + a.showPara.join(", ") + ")", meta: a.showRetType})
            }));
            var l = a.concat(t), c = {
                getCompletions: function (e, a, t, s, o) {
                    if (0 === s.length)return void o(null, []);
                    var n = $.grep(l, function (e) {
                        return e.value.indexOf(s) >= 0
                    });
                    o(null, n.map(function (e) {
                        return {value: e.value, meta: e.meta, caption: e.caption}
                    }))
                }
            };
            u.setCompleters([u.snippetCompleter, u.textCompleter, u.keyWordCompleter, c]), e.setOptions({
                enableBasicAutocompletion: !0,
                enableSnippets: !0,
                enableLiveAutocompletion: !0
            })
        })
    };
    var f, w = {}, C = {}, S = !1;
    this.copyStrategy = function () {
        $.getJSON("/strategy/copyStrategy", {strategyId: $("#strategyId").val()}).done(function (e) {
            e.success ? window.location.href = "/strategy/edit/" + e.strategyId : ($("#message").text(e.message), i.showLayer($("#responseBox")))
        })
    }, this.save = function () {
        v = !1, g = !1, o(!0)
    }, this.compile = function () {
        var e = m.getValue();
        return "" == e | void 0 == e | null == e | "" == jQuery.trim(e) ? ($("#message").text("策略代码不能为空＿"), i.showLayer($("#responseBox")), !1) : new Date($("#startDate").val()).getTime() > new Date($("#endDate").val()).getTime() ? ($("#message").text("时间区域选择不正确！"), i.showLayer($("#responseBox")), !1) : (v = !0, h.logRequestId = null, h.backTestStatus = "回测丿", void o(h.canEdit ? !0 : !1))
    }, this.backTest = function () {
        var e = m.getValue();
        return "" == e | void 0 == e | null == e | "" == jQuery.trim(e) ? ($("#message").text("策略代码不能为空＿"), i.showLayer($("#responseBox")), !1) : new Date($("#startDate").val()).getTime() > new Date($("#endDate").val()).getTime() ? ($("#message").text("时间区域选择不正确！"), i.showLayer($("#responseBox")), !1) : (g = !0, void o(h.canEdit ? !0 : !1))
    }, this.cancelTest = function () {
        $.getJSON("/run/cancelTest", {
            strategyId: $("#strategyId").val(),
            requestTime: $("#requestTime").val()
        }).done(function (e) {
            e.success ? (console.log(e.message), $(".b-jin").hide(), $("#compileValue").html("0%"), $("#compileBar").width(0), y.close()) : ($("#message").text(e.message), i.showLayer($("#responseBox")))
        })
    }, this.closeMessageBox = function () {
        i.hideLayer($("#responseBox"))
    }, this.isOnContest = function () {
        $.getJSON("/contest/isOnContest", {strategyId: $("#strategyId").val()}).done(function (e) {
            e.success ? (h.onContest = e.verify.isContestStrategy, h.contestId = e.verify.contestId, h.versionId = e.verify.strategyVersionId) : (console.log(e.message), alert("操作失败，请稍后再试!"))
        })
    }
};